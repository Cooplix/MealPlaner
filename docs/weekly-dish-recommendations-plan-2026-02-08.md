# План покращення рекомендацій страв на тиждень

Дата: 2026-02-08

## 1. Мета
Покращити рекомендації у календарі так, щоб вони:
- краще закривали тижневий план без повторів,
- враховували наявні запаси і строки придатності,
- підтримували баланс калорійності та вартості,
- навчалися на діях користувача (додав/пропустив/відхилив).

## 2. Поточний стан (по коду)
- Рекомендації обчислюються у `CalendarPage.tsx` локально на фронтенді.
- Базовий підхід:
  - прибрати страви, які вже присутні у поточному тижні,
  - порахувати перетин інгредієнтів із пулом інгредієнтів тижня (`overlap`),
  - відсортувати за `overlap` і взяти top-12.
- Немає урахування:
  - запасів і терміну придатності,
  - бюджету/собівартості,
  - різноманіття по днях та типах страв,
  - персональних уподобань.

## 3. Основні проблеми
1. Одновимірний скоринг (тільки ingredient overlap).
2. Частина рекомендацій може бути дорогою або неактуальною по запасах.
3. Немає персоналізації на основі історії взаємодій.
4. Логіка лише у фронтенді, її важко масштабувати і перевикористовувати.

## 4. Цільова модель рекомендацій

## 4.1 Кандидати
- Генерувати кандидатів окремо по кожному meal-slot (`breakfast/lunch/dinner/snack`).
- Виключати:
  - вже додані страви у тижні,
  - страви, що порушують явні обмеження (якщо будуть задані користувачем).

## 4.2 Multi-factor scoring (ваговий)
Підсумковий бал страви:
`score = w1*overlap + w2*inventoryFit + w3*expiryUsage + w4*variety + w5*nutritionFit + w6*costFit + w7*preferenceFit`

Де:
- `overlap`: перетин з уже запланованими інгредієнтами (для оптимізації закупівель).
- `inventoryFit`: чи вистачає запасів для страви.
- `expiryUsage`: бонус за використання інгредієнтів, що скоро закінчуються.
- `variety`: штраф за повтори схожих страв/інгредієнтів протягом тижня.
- `nutritionFit`: баланс по калоріях і базових макро-патернах на день/тиждень.
- `costFit`: оцінка очікуваної вартості страви (на базі recent purchases).
- `preferenceFit`: сигнали з історії користувача (часті додавання, skip/dislike).

## 4.3 Explainability
Для кожної рекомендації віддавати `reasons[]`, наприклад:
- `high_overlap`
- `uses_expiring_ingredients`
- `low_estimated_cost`
- `fits_calorie_target`

Це потрібно для довіри і швидкого ручного контролю.

## 5. Дані, яких бракує

## 5.1 Нові поля/сутності
- `dish_metadata`:
  - `prep_time_min`,
  - `difficulty`,
  - `tags[]` (швидко, бюджетно, білкова, тощо),
  - `servings` (опціонально).
- `user_preferences`:
  - улюблені/небажані інгредієнти,
  - ціль по калоріях,
  - бюджетний пріоритет,
  - пріоритет різноманіття.
- `recommendation_feedback`:
  - `shown`, `added`, `skipped`, `dismissed`.

## 5.2 Сигнали з існуючих модулів
- `inventory`:
  - доступна кількість,
  - мін/макс,
  - строк придатності.
- `purchases`:
  - актуальні ціни для оцінки собівартості.
- `calories`:
  - оцінка калорійності страв.

## 6. Архітектурний план

## 6.1 Перенесення логіки на бекенд
- Додати `RecommendationService` у `server-java`.
- Винести скоринг із `CalendarPage.tsx` в API, щоб мати єдину логіку.

## 6.2 Нові API
- `GET /api/recommendations/weekly?start=YYYY-MM-DD`
  - повертає рекомендації по слотах з `score` і `reasons`.
- `POST /api/recommendations/feedback`
  - фіксує дії користувача по рекомендаціях.
- `GET /api/recommendations/config`
  - ваги/параметри для дебагу і тонкого налаштування.

## 6.3 Frontend інтеграція
- У календарі:
  - показувати бейджі причин (`reasons`),
  - додати явні дії `Add`, `Skip`, `Hide`.
- Після кожної дії надсилати feedback event.

## 7. Покроковий план реалізації

### Крок 1. Інструментація поточного сценарію
- Додати події `recommendation_shown` і `recommendation_added`.
- Зібрати baseline метрики за 1-2 тижні.

DoD:
- Є журнал взаємодій, baseline зафіксований.

### Крок 2. Recommendation API v1 (еквівалент поточної логіки)
- Реалізувати backend endpoint з поточним `overlap` алгоритмом.
- Фронт перейти на API, не змінюючи UX.

DoD:
- Результати збігаються з поточною логікою, але обчислення вже на бекенді.

### Крок 3. Інтеграція запасів
- Додати `inventoryFit` і `expiryUsage` у скоринг.
- Враховувати тільки продукти поточного користувача.

DoD:
- Рекомендації частіше використовують те, що вже є в запасах.

### Крок 4. Інтеграція вартості
- Додати оцінку вартості страви на основі `purchases`.
- Додати `costFit` у скоринг.

DoD:
- Підтримується режим пріоритету бюджетних страв.

### Крок 5. Диверсифікація
- Додати штраф за повтори інгредієнтів/типів страв протягом тижня.
- Додати `variety` у скоринг.

DoD:
- Меню стає різноманітнішим при збереженні практичності закупівель.

### Крок 6. Базова персоналізація
- Використати feedback (`added/skipped/dismissed`) для `preferenceFit`.
- Додати просту user-profile конфігурацію пріоритетів.

DoD:
- Система адаптується до дій користувача.

### Крок 7. Explainability UI
- Показувати причини (`reasons`) біля кожної рекомендації.

DoD:
- Користувач бачить, чому саме ця страва рекомендована.

### Крок 8. A/B перевірка ваг
- Прогнати 2-3 набори ваг скорингу.
- Вибрати профіль з найкращими метриками.

DoD:
- Затверджений production weight profile.

### Крок 9. Оптимізація продуктивності
- Кеш рекомендацій по `user_id + week_start`.
- Інвалідація при змінах плану/запасів/покупок.

DoD:
- API відповідає швидко і стабільно під навантаженням.

### Крок 10. Реліз і контроль якості
- Інтеграційні тести API.
- E2E smoke-сценарій в календарі.

DoD:
- Рекомендації працюють стабільно і вимірювано краще baseline.

## 8. Метрики успіху
- `recommendation_add_rate` +20% від baseline.
- `skip_or_dismiss_rate` -15% від baseline.
- `inventory_usage_rate` (частка використаних запасів у запланованих стравах) +25%.
- `weekly_menu_variety_score` +15%.
- `median_recommendation_latency` < 250ms (з кешем).

## 9. Ризики
- Неповні або неякісні дані по запасах/покупках спотворюють скоринг.
- Надмірна оптимізація на overlap може знизити різноманіття.
- Без explainability користувач може не довіряти автоматичним рекомендаціям.

## 10. Prompt-ready формат
- `Реалізуй крок 1 з docs/weekly-dish-recommendations-plan-2026-02-08.md`
- `Реалізуй крок 2 з docs/weekly-dish-recommendations-plan-2026-02-08.md`
- ...
- `Реалізуй крок 10 з docs/weekly-dish-recommendations-plan-2026-02-08.md`
